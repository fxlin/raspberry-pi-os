<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>ssh - p1-kernel</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">p1-kernel</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../lesson00/rpi-os/" class="nav-link">exp0</a>
                            </li>
                            <li class="navitem">
                                <a href="../lesson01/rpi-os/" class="nav-link">exp1</a>
                            </li>
                            <li class="navitem">
                                <a href="../lesson02/rpi-os/" class="nav-link">exp2</a>
                            </li>
                            <li class="navitem">
                                <a href="../lesson03/rpi-os/" class="nav-link">exp3</a>
                            </li>
                            <li class="navitem">
                                <a href="../lesson04a/rpi-os/" class="nav-link">exp4a</a>
                            </li>
                            <li class="navitem">
                                <a href="../lesson04b/rpi-os/" class="nav-link">exp4b</a>
                            </li>
                            <li class="navitem">
                                <a href="../lesson05/rpi-os/" class="nav-link">exp5</a>
                            </li>
                            <li class="navitem">
                                <a href="../lesson06/rpi-os/" class="nav-link">exp6</a>
                            </li>
                            <li class="navitem">
                                <a href="../gdb/" class="nav-link">gdb</a>
                            </li>
                            <li class="navitem">
                                <a href="../cheatsheet/" class="nav-link">cheatsheet</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">ssh</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../cheatsheet/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#access-the-cs-servers" class="nav-link">Access the CS servers</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#terminal-over-ssh" class="nav-link">Terminal over SSH</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#1-use-key-based-authentication-in-lieu-of-password" class="nav-link">1. Use key-based authentication in lieu of password</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#2-connect-to-cs-servers-using-one-line-of-command" class="nav-link">2. Connect to CS servers using one line of command</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#3-save-connection-info-in-ssh-config" class="nav-link">3. Save connection info in SSH config</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#remote-development-with-vscode" class="nav-link">Remote development with VSCode</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="3"><a href="#windows-caveat-1-ssh-keys" class="nav-link">Windows caveat 1: ssh keys</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#windows-caveat-2-an-outdated-ssh-client" class="nav-link">Windows caveat 2: an outdated ssh client</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#launch-a-terminal" class="nav-link">Launch a terminal</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="3"><a href="#file-browsing-editing" class="nav-link">File browsing &amp; editing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="access-the-cs-servers">Access the CS servers</h1>
<ul>
<li><a href="#terminal-over-ssh">Terminal over SSH</a><ul>
<li><a href="#1-use-key-based-authentication-in-lieu-of-password">1. Use key-based authentication in lieu of password</a></li>
<li><a href="#2-connect-to-cs-servers-using-one-line-of-command">2. Connect to CS servers using one line of command</a></li>
<li><a href="#3-save-connection-info-in-ssh-config">3. Save connection info in SSH config</a></li>
</ul>
</li>
<li><a href="#remote-development-with-vscode">Remote development with VSCode</a><ul>
<li><a href="#windows-caveat-1-ssh-keys">Windows caveat 1: ssh keys</a></li>
<li><a href="#windows-caveat-2-an-outdated-ssh-client">Windows caveat 2: an outdated ssh client</a></li>
<li><a href="#launch-a-terminal">Launch a terminal</a></li>
<li><a href="#file-browsing--editing">File browsing &amp; editing</a></li>
</ul>
</li>
</ul>
<p>This document describes server resources and how to connect for development. </p>
<table>
<thead>
<tr>
<th></th>
<th>Projects</th>
<th>hardware specs</th>
<th>OS</th>
</tr>
</thead>
<tbody>
<tr>
<td>granger1.cs.virginia.edu</td>
<td>p1,p3,p4</td>
<td>Dual Xeon 2630v4 Broadwell (10c20t), 20 cores</td>
<td>Ubuntu 20.04 LTS</td>
</tr>
<tr>
<td>labsrv06.cs.virginia.edu</td>
<td>p1,p2,p3,p4</td>
<td>Single Xeon Silver 4410 CPU (8c16t), 8 cores</td>
<td>Ubuntu 20.04 LTS</td>
</tr>
</tbody>
</table>
<p>Using your CS credentials (not the UVA ones). See <a href="https://www.cs.virginia.edu/wiki/doku.php?id=compute_resources">wiki page</a>. Contact felixlin@ if you do not have CS credentials. </p>
<p>These servers are behind the campus firewall. You need to first SSH to <strong>portal.cs.virginia.edu</strong>, and from there SSH over to the CS servers, e.g. labsrv06. This is described <a href="https://www.cs.virginia.edu/wiki/doku.php?id=linux_ssh_access">here</a>. </p>
<p><img src="images/servers.png" alt="image-20210124164456011" style="zoom:50%;" /></p>
<h2 id="terminal-over-ssh">Terminal over SSH</h2>
<pre><code>$ ssh xl6yq@portal.cs.virginia.edu
(type in password...)
Warning: No xauth data; using fake authentication data for X11 forwarding.
Last login: Sun Jan 24 16:48:29 2021 from c-71-62-166-85.hsd1.va.comcast.net
********************************** **********************
Type &quot;module avail&quot; to see software available.
See: www.cs.virginia.edu/computing for more information.

$ ssh xl6yq@granger1.cs.virginia.edu
(type in password...)
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-45-generic x86_64)
</code></pre>
<p>SSH Connecting to CS servers can be automated. </p>
<p><img alt="" src="../images/ssh-proxy.gif" /></p>
<p>The picture shows the final results: From a local terminal (e.g. my minibox), connecting to a CS server by simply typing <code>ssh granger1</code>. Read on for how to configure.</p>
<h3 id="1-use-key-based-authentication-in-lieu-of-password">1. Use key-based authentication in lieu of password</h3>
<p>Applicable local environment: Linux, Windows (WSL)</p>
<p>The pub key on your local machine is at <code>~/.ssh/id_rsa.pub</code>. Check out the file &amp; its content. If it does not exist, generate a pub key by running <code>ssh-keygen</code>. </p>
<pre><code># on the local console (Linux or WSL)
$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/xzl/.ssh/id_rsa):
</code></pre>
<p>Now, append your pubic key to both portal and granger1 (<code>~/.ssh/authorized_keys</code>). </p>
<p>Don't do this manually. Instead, do so by the command <code>ssh-copy-id</code>. For instance: </p>
<pre><code># copy the pubkey from your local machine to portal
$ ssh-copy-id xl6yq@portal.cs.virginia.edu
(... type in password ...)

# connect to &quot;portal&quot;, it should no longer ask for password
$ ssh xl6yq@portal.cs.virginia.edu

# now we are on &quot;portal&quot;, copy the pubkey to the cs server
$ ssh-copy-id xl6yq@granger1.cs.virginia.edu
(... type in password ...)

# it should no longer ask for password
$ ssh xl6yq@granger1.cs.virginia.edu
</code></pre>
<p>If things do not work, e.g. servers keep asking for passwords even after copying ssh key over, chances are that these keys do not have right file permissions on your local machine filesystem or on the server filesystem. A quick Googling can yield quick fixes. </p>
<h3 id="2-connect-to-cs-servers-using-one-line-of-command">2. Connect to CS servers using one line of command</h3>
<pre><code>$ ssh -l USERNAME granger1.cs.virginia.edu -J portal.cs.virginia.edu
</code></pre>
<p>The -J option is available with your local ssh client OpenSSH &gt;= 7.3p1. See <a href="https://unix.stackexchange.com/questions/423205/can-i-access-ssh-server-by-using-another-ssh-server-as-intermediary/423211#423211">here</a> for more details. For instance, my version: </p>
<pre><code>$ ssh -V
OpenSSH_7.6p1 Ubuntu-4ubuntu0.3, OpenSSL 1.0.2n  7 Dec 2017
</code></pre>
<h3 id="3-save-connection-info-in-ssh-config">3. Save connection info in SSH config</h3>
<p>Append the following to your ssh client configuration (<code>~/.ssh/config</code>). <strong>Replace USERNAME with your actual username</strong>: </p>
<pre><code>Host granger1
   User USERNAME
   HostName granger1.cs.virginia.edu
   ProxyJump USERNAME@portal.cs.virginia.edu:22
</code></pre>
<p>With the configuration, your local ssh client knows that when connecting  to host <code>granger1</code>, use <code>portal</code> as the jump proxy. So you can directly connect to <code>granger1</code> from your local machine: </p>
<pre><code>$ ssh granger1
</code></pre>
<h2 id="remote-development-with-vscode">Remote development with VSCode</h2>
<p>Many students may prefer VSCode. Here is how to make it work for our kernel hacking. </p>
<p>End results: being able to develop, compile, and do version control from VSCode. See an example screenshot below. </p>
<p><img alt="image-20210124192213976" src="../images/vscode-remote-files.png" /></p>
<p>So we will use VSCode's official Remote.SSH extension. I do not recommend 3rd party extensions, e.g. sftp. </p>
<p>An official tutorial is <a href="https://code.visualstudio.com/docs/remote/ssh">here</a>. </p>
<p>tl;dr: VSCode will connect to the CS server (Linux) using SSH under the hood. To do so you install the "Remote development" <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack">package</a> which will install the "Remote.SSH" extension for VSCode. </p>
<h3 id="windows-caveat-1-ssh-keys">Windows caveat 1: ssh keys</h3>
<p>The extension (Remote.SSH) will invoke Window's ssh client (<code>c:\Windows\System32\OpenSSH\ssh.exe</code>), which different from the ssh client that you run in WSL. The Window's ssh client expects its config file at <code>C:\Users\%USERNAME%\.ssh\config</code>. If you haven't generated your SSH keys so far, you can do so by launching a PowerShell console and run <code>ssh-keygen</code> there. </p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/powershell.png" /></th>
<th><img alt="" src="../images/powershell-sshkeygen.png" /></th>
<th><img alt="" src="../images/wslroot.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Launch PowerShell</em></td>
<td><em>ssh-keygen in PowerShell</em></td>
<td><em>Access WSL root</em></td>
</tr>
</tbody>
</table>
<p>Or, you can you copy existing ssh keys and config (e.g. from WSL <code>~/.ssh/</code>) to the location mentioned above. Btw, the way to access WSL's root filesystem is to type <code>\\wsl$</code> in the explorer address bar. See the figure above. </p>
<h3 id="windows-caveat-2-an-outdated-ssh-client">Windows caveat 2: an outdated ssh client</h3>
<p>The current VSCode has a bug that breaks ssh with jumphost. You have to manually fix it by following <a href="https://github.com/microsoft/vscode-remote-release/issues/18#issuecomment-507258777">this</a>. In a nutshell, manual download a newer win32 ssh to overwrite the one shipping with Win 10 (it's a good idea to save a back up). Window's security mechanism is in your way. Work around it. </p>
<table>
<thead>
<tr>
<th><img src="images/vscode-ssh-override.png" alt="image-20210124190827946" style="zoom:50%;" /></th>
<th><img src="images/win-ssh-version.png" alt="image-20210124190904980" style="zoom: 67%;" /></th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Turning off protection on ssh.exe (see link above)</em></td>
<td><em>The newer ssh client manually installed</em></td>
</tr>
</tbody>
</table>
<p>Now, you should be good to go with VSCode. </p>
<p>Make sure you have the Remote.SSH extension installed. Click "Remote Explorer" on the left bar. The extension will pick up your ssh config file (again that's <code>C:/Users/%USERNAME%/.ssh/config</code>) and present a list of hosts recognized. Click one to connect to it. The extension will copy a bunch of stuffs to the host and launch some daemon on the host. Then you are connected. </p>
<h3 id="launch-a-terminal">Launch a terminal</h3>
<p>After connection, click "remote" on the left bar to bring up a remote terminal, in which you can execute commands to build projects, etc. Make sure to click the "+" sign to create a new terminal. </p>
<p><img alt="image-20210124192109456" src="../images/vscode-remote-terminal.png" /></p>
<h3 id="file-browsing-editing">File browsing &amp; editing</h3>
<p>Then you will specify a remote folder on the server to "open": </p>
<p><img alt="image-20210124192002504" src="../images/vscode-remote-folder.png" /></p>
<p>To browse &amp; edit files on the server, click "explorer" on the left bar</p>
<p><img alt="image-20210124192213976" src="../images/vscode-remote-files.png" /></p>
<p>Click  "source control" on the left bar for a handy git interface. </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
